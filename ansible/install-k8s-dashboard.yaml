- name: Create a k8s namespace
  kubernetes.core.k8s:
    name: kubernetes-dashboard
    api_version: v1
    kind: Namespace
    state: present

- name: Add k8s dashboard chart repo
  kubernetes.core.helm_repository:
    name: kubernetes-dashboard
    repo_url: "https://kubernetes.github.io/dashboard/"
    binary_path: /snap/bin/helm

- name: Deploy k8s dashboard chart using set values on target
  kubernetes.core.helm:
    binary_path: /snap/bin/helm
    name: kubernetes-dashboard
    chart_ref: kubernetes-dashboard/kubernetes-dashboard
    release_namespace: kubernetes-dashboard
    # values:
    #   ingress:
    #     enabled: true
    #     ingressClassName: traefik
    #     annotations:
    #       cert.manager.io/cluster-issuer: kubernetes-dashboard
    #       traefik.ingress.kubernetes.io/router.entrypoints: web, websecure
    #     path: /kubernetes-dashboard
    #     pathType: Prefix
    #     hosts:
    #       - "{{ hostname | default(default_hostname) }}"
    #     issuer:
    #       scope: cluster

- name: Copy ingress manifest
  template:
    src: "k8s_manifests/k8s_dash_ingress.yaml.j2"
    dest: "{{ ansible_facts['user_dir'] }}/k8s_dash_ingress.yaml"
    mode: "0644"

- name: Apply ingress manifest to the cluster
  kubernetes.core.k8s:
    state: present
    namespace: kubernetes-dashboard
    src: "{{ ansible_facts['user_dir'] }}/k8s_dash_ingress.yaml"

- name: Print URL
  debug:
    msg: "https://{{ hostname | default(default_hostname) }}/kubernetes-dashboard"
