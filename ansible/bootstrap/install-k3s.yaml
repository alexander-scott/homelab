# Taken from https://github.com/docker/docker-install
- name: Install docker
  shell: curl -sfL https://get.docker.com | sh -
  become: true

- name: Add current user to docker group
  user:
    name: "{{ ansible_user }}"
    groups: docker
    append: true
  become: true

- name: Restart docker service
  systemd_service:
    state: restarted
    daemon_reload: true
    name: docker
  become: true

- name: Make sure K3s dir exists
  file:
    path: "/etc/rancher/k3s"
    state: directory
  become: true

- name: Create K3s configuration file
  copy:
    dest: /etc/rancher/k3s/config.yaml
    mode: 0644
    content: |
      tls-san:
        - "{{ hostname }}"
  become: true

# Taken from https://docs.k3s.io/quick-start
- name: Install k3s
  shell: curl -sfL https://get.k3s.io | sh -
  become: true

- name: Ensure .kube dir exists
  file:
    path: "{{ ansible_facts['user_dir'] }}/.kube"
    state: directory

- name: Copy file to home dir
  copy:
    dest: "{{ ansible_facts['user_dir'] }}/.kube/config"
    src: /etc/rancher/k3s/k3s.yaml
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    remote_src: true
    mode: "0600"
  become: true

- name: Update bashrc for KUBECONFIG env var
  lineinfile:
    dest: "{{ ansible_facts['user_dir'] }}/.bashrc"
    line: "export KUBECONFIG=~/.kube/config"
    regexp: ".*KUBECONFIG.*"
    owner: "{{ ansible_user }}"
    state: present
    insertafter: EOF
    create: True

- name: Update bashrc for kubectl auto-completion
  lineinfile:
    dest: "{{ ansible_facts['user_dir'] }}/.bashrc"
    line: "source <(kubectl completion bash)"
    regexp: ".*kubectl completion bash.*"
    owner: "{{ ansible_user }}"
    state: present
    insertafter: EOF
    create: True

- name: Install helm
  community.general.snap:
    name: helm
    classic: true
    channel: latest/edge # There are breaking changes in 4 (unknown flag: --all)
  become: true

- name: Create fact file
  copy:
    dest: /etc/ansible/facts.d/install_k3s.fact
    mode: 0644
    content: |
      {}
